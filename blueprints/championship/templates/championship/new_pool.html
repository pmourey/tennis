<!-- templates/new_pool.html -->
{% extends 'base.html' %}
{% include './partials/_menu.html' %}

{% block main %}
<main>
    {% if clubs %}
        <form action="{{ url_for('championship.new_pool', championship_id=championship.id) }}" method="POST">
        <table class="update-form">
            <caption class="table-caption">Fiche création poule {{championship}}</caption>
            <tr>
                <td>
                    <div id="clubs_container">
                         <select name="clubs[]" class="championship-club">
                            <option value="">Sélectionner un club</option>
                            {% for club in clubs %}
                                <option value="{{ club.id }}" {% if selected_clubs and club.id in selected_clubs %}selected{% endif %}>{{ club.name }}</option>
                            {% endfor %}
                        </select>
                        <br>
                    </div>
                    <br><button type="button" id="add_club_button">Ajouter un club</button>
                </td>
            </tr>
            <tr>
                <td><input type="submit" value="Créer poule"></td>
            </tr>
        </table>
    </form>
    {% else %}
        <p style="font-size: 16px; text-align: center;">Pas de club éligible pour ce championnat! ✌️</p>
    {% endif %}
</main>
<script>
    {% set M = championship.matchdays|length %}
    {% set num_teams_per_pool = (M + 1) if (M % 2 == 0) else M %}

    const clubs = [
        {% for club in clubs %}
            {
                id: "{{ club.id }}",
                name: "{{ club.name }}"
            }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    function createClubSelect(selectedValue = '') {
        const wrapper = document.createElement('div');
        wrapper.classList.add('mb-3');

        const newClubSelect = document.createElement('select');
        newClubSelect.setAttribute('name', 'clubs[]');
        newClubSelect.classList.add('championship-club', 'form-select');

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Sélectionner un club';
        newClubSelect.appendChild(defaultOption);

        clubs.forEach(club => {
            const newClubOption = document.createElement('option');
            newClubOption.value = club.id;
            newClubOption.textContent = club.name;
            if (club.id === selectedValue) {
                newClubOption.selected = true;
            }
            newClubSelect.appendChild(newClubOption);
        });

        wrapper.appendChild(newClubSelect);
        return wrapper;
    }
    
    // Recreate additional selects for selected clubs on page load
    {% if selected_clubs and selected_clubs|length > 0 %}
    const selectedClubs = {{ selected_clubs|tojson }};
    const clubsContainer = document.getElementById('clubs_container');
    
    // Set first select value
    const firstSelect = document.querySelector('select[name="clubs[]"]');
    if (firstSelect && selectedClubs.length > 0) {
        firstSelect.value = selectedClubs[0];
    }
    
    // Create additional selects for remaining selections
    for (let i = 1; i < selectedClubs.length; i++) {
        const newLine = document.createElement('br');
        clubsContainer.appendChild(newLine);
        clubsContainer.appendChild(createClubSelect(selectedClubs[i]));
    }
    {% endif %}
    
    document.getElementById('add_club_button').addEventListener('click', function() {
        const clubsContainer = document.getElementById('clubs_container');
        const newLine = document.createElement('br');
        clubsContainer.appendChild(newLine);
        clubsContainer.appendChild(createClubSelect());
    });
</script>

{% endblock %}
