<!-- templates/list_championships.html -->
{% extends 'base.html' %}
{% include './partials/_menu.html' %}

{% block main %}
<main>
    <!-- Season filter -->
    <div style="margin-bottom: 20px; position: relative; display: inline-block;">
        <label>Filtrer par saison sportive :</label>
        <button id="season-dropdown" onclick="toggleDropdown()" style="padding: 8px 12px; border: 1px solid #ccc; background: white; cursor: pointer;">
            {{ display_title }} ▼
        </button>
        <button onclick="resetFilter()" style="padding: 8px 12px; margin-left: 5px; border: 1px solid #ccc; background: #f0f0f0; cursor: pointer;">
            Saison courante
        </button>
        <div id="dropdown-content" style="display: none; position: absolute; background: white; border: 1px solid #ccc; z-index: 1000; min-width: 200px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
            <div class="dropdown-option {% if 'all' in selected_seasons %}selected{% endif %}" data-value="all" onclick="toggleOption(this)" style="padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;">
                Toutes les années
            </div>
            {% for season in available_seasons %}
                <div class="dropdown-option {% if season in selected_seasons %}selected{% endif %}" data-value="{{ season }}" onclick="toggleOption(this)" style="padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;">
                    {{ season }}{% if season == current_season %} (actuelle){% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
    
    {% if championships %}
    <table class="championships">
        <caption class="table-caption">Liste des championnats - {{ display_title }}</caption>
        <thead>
        <tr>
            <th>Nom</th>
            <th>Nb équipes</th>
            <th>Nb poules</th>
            <th>Nb journées</th>
            <th>Nb simples / doubles</th>
            <th>Période</th>
            <th>Action</th>
        </tr>
        </thead>
        {% for championship in championships %}
        {% set exempted_pool = 1 if championship.exempted_teams else 0 %}
        {% set singles_label = 'simples' if championship.singlesCount > 1 else 'simple' %}
        {% set doubles_label = 'doubles' if championship.doublesCount > 1 else 'double' %}
        {% set start_date = championship.start_date.strftime('%d/%m') if championship.start_date else '' %}
        {% set end_date = championship.end_date.strftime('%d/%m') if championship.end_date else '' %}
        <div id="pool">
            <tr>
                <td><a href="{{ url_for('championship.show_pools', id=championship.id) }}">{{ championship.name }}</a></td>
                <td>{{ championship.teams|length }}</td>
                <td>{{ championship.pools|length - exempted_pool }}</td>
                <td>{{ championship.matchdays|length }}</td>
                <td>{{ championship.singlesCount }} {{singles_label}} / {{ championship.doublesCount }} {{doubles_label}}</td>
                <td>{{ start_date }}-{{ end_date }}</td>
<!--                <td>-->
<!--                    <form action="{{ url_for('championship.simulate_championship', championship_id=championship.id) }}" method="post">-->
<!--                        <input type="submit" value="Simulate" onclick="return confirm('Are you sure you want to simulate this championship?\nThis will takes about 2 minutes!')">-->
<!--                    </form>-->
<!--                </td>-->
                {% if championship.pools %}
                    <td>
                        <form action="{{ url_for('championship.delete_championship', championship_id=championship.id) }}" method="post">
                            <input type="submit" value="Delete" onclick="return confirm('Are you sure you want to delete this championship?')">
                        </form>
                    </td>
                {% else %}
                    <td>
                        <form action="{{ url_for('championship.configure_pools', championship_id=championship.id) }}" method="get">
                            <input type="submit" value="Configure Pools">
                        </form>
                    </td>
                {% endif %}
            </tr>
        </div>
        {%endfor %}
    </table>
    {% else %}
    <p style="font-size: 16px; text-align: center;">Pas de championnat pour {{ display_title }}! ✌️</p>
    {% endif %}
</main>

<style>
.dropdown-option.selected {
    background-color: #007cba;
    color: white;
}
.dropdown-option:hover {
    background-color: #f0f0f0;
}
.dropdown-option.selected:hover {
    background-color: #005a87;
}
</style>

<script>
function toggleDropdown() {
    const dropdown = document.getElementById('dropdown-content');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

function resetFilter() {
    window.location.href = '{{ url_for("championship.show_championships") }}?seasons={{ current_season }}';
}

function toggleOption(element) {
    const isAll = element.dataset.value === 'all';
    
    if (isAll) {
        // If "all" is selected, deselect all other options
        document.querySelectorAll('.dropdown-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        element.classList.add('selected');
    } else {
        // If a specific season is selected, deselect "all"
        const allOption = document.querySelector('.dropdown-option[data-value="all"]');
        if (allOption) {
            allOption.classList.remove('selected');
        }
        element.classList.toggle('selected');
    }
    
    const selectedOptions = document.querySelectorAll('.dropdown-option.selected');
    const selectedSeasons = Array.from(selectedOptions).map(opt => opt.dataset.value);
    
    if (selectedSeasons.length === 0) {
        return;
    }
    
    const params = new URLSearchParams();
    selectedSeasons.forEach(season => {
        params.append('seasons', season);
    });
    
    window.location.href = '{{ url_for("championship.show_championships") }}?' + params.toString();
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('dropdown-content');
    const button = document.getElementById('season-dropdown');
    if (!button.contains(event.target) && !dropdown.contains(event.target)) {
        dropdown.style.display = 'none';
    }
});
</script>

{% endblock main %}
